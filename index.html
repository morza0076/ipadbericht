<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="default" />
    <meta name="apple-mobile-web-app-title" content="Leckortungsbericht" />
    <title>Leckortungsbericht</title>

    <style>
        :root { --accent:#b89b1e; --text:#1f1f1f; --bg:#f4f1e8; --border:#ccc; }
        * { box-sizing:border-box; -webkit-print-color-adjust:exact; print-color-adjust:exact; }

        /* Druckr√§nder 0 f√ºr saubere PDFs per Browser-Druck */
        @page { size:A4; margin:0 !important; }

        body { font-family:"Segoe UI", Roboto, Arial, sans-serif; background:var(--bg); margin:0; padding:10px; color:var(--text); }

        .page {
            width:210mm; min-height:297mm; background:#fff; padding:12mm;
            margin:0 auto 20px auto; position:relative; box-shadow:0 0 10px rgba(0,0,0,.1);
            overflow:hidden;
        }

        .header { display:flex; justify-content:space-between; align-items:flex-start; border-bottom:2px solid var(--accent); padding-bottom:8px; margin-bottom:12px; }
        .header-left { display:flex; flex-direction:column; gap:6px; align-items:flex-start; }
        .logo { max-height:55px; width:auto; object-fit:contain; }
        .header-left h1 { margin:0; font-size:22px; color:var(--text); text-transform:uppercase; }
        .header-right { text-align:right; font-size:10px; line-height:1.3; }

        .section { margin-bottom:10px; }
        .section h2 { font-size:13px; text-transform:uppercase; border-bottom:1px solid #eee; padding-bottom:3px; margin-bottom:6px; color:var(--accent); font-weight:700; }

        .grid { display:grid; grid-template-columns:1fr 1fr; gap:8px; }
        .label { font-size:10px; font-weight:700; margin-bottom:2px; display:block; color:#555; }
        input, textarea, select { width:100%; border:1px solid var(--border); padding:6px; font-size:12px; border-radius:3px; background:#fff; outline:none; }
        textarea { min-height:40px; font-family:inherit; resize:none; overflow:hidden; line-height:1.4; }

        .checkbox-group { display:grid; grid-template-columns:1fr 1fr; gap:4px; font-size:11px; }
        .checkbox-item { display:flex; align-items:center; gap:4px; cursor:pointer; }
        .checkbox-item input { width:auto; margin:0; }

        .drawing-area { border:1px solid var(--border); background:#fafafa; cursor:crosshair; touch-action:none; position:relative; width:100%; border-radius:4px; }
        .sketch-box { height:450px; margin-top:10px; }

        .toolbar { display:flex; gap:10px; margin-bottom:10px; align-items:center; background:#eee; padding:8px; border-radius:5px; }
        .tool { width:25px; height:25px; border-radius:50%; border:2px solid #fff; cursor:pointer; }
        .tool.active { border:2px solid #000; transform:scale(1.1); }
        .tool.eraser { background:#fff; border:1px solid #ccc; display:flex; align-items:center; justify-content:center; font-size:14px; }

        .photo-grid { display:grid; grid-template-columns:1fr 1fr; gap:15px; margin-top:10px; }
        .photo-box { border:1px solid #ddd; padding:8px; text-align:center; background:#fff; border-radius:4px; break-inside:avoid; page-break-inside:avoid; }
        .img-container { position:relative; width:100%; height:240px; background:#f9f9f9; margin-bottom:8px; overflow:hidden; cursor:crosshair; }
        .img-container img { width:100%; height:100%; object-fit:contain; pointer-events:none; }
        .marker-arrow { position:absolute; width:40px; height:40px; transform:translate(-100%, -100%); pointer-events:none; filter:drop-shadow(1px 1px 2px rgba(0,0,0,.5)); }
        .photo-desc { width:100%; border:none; border-bottom:1px solid var(--accent); font-size:12px; padding:4px 0; }

        .footer { position:absolute; bottom:10mm; left:12mm; right:12mm; font-size:9px; display:flex; justify-content:space-between; color:#888; border-top:1px solid #eee; padding-top:5px; }

        #controls { position:fixed; top:10px; right:10px; z-index:100; display:flex; flex-direction:column; gap:8px; width:260px; }
        button { padding:12px; background:var(--accent); color:#fff; border:none; border-radius:4px; cursor:pointer; font-weight:700; font-size:11px; }
        button.secondary { background:#444; }

        /* Mobile */
        @media screen and (max-width:768px) {
            body { padding:4px; background:#e5e2d8; }
            .page { width:100%; min-height:auto; margin:0 0 12px 0; padding:10px 8px 16px 8px; box-shadow:none; border-radius:0; }
            .header { flex-direction:column; align-items:flex-start; gap:6px; }
            .header-right { text-align:left; }
            .grid { grid-template-columns:1fr; }
            #controls { position:sticky; top:0; right:auto; left:0; width:100%; flex-direction:row; flex-wrap:wrap; gap:6px; padding:4px; background:rgba(244,241,232,.95); box-shadow:0 2px 4px rgba(0,0,0,.1); }
            #controls button { flex:1 1 45%; min-width:120px; }
            .sketch-box { height:60vh; }
            .photo-grid { grid-template-columns:1fr; }
            .img-container { height:220px; }
        }

        @media print {
            body { background:#fff; padding:0; margin:0; }
            #controls, .toolbar, .no-print, #photoInput, #importFile { display:none !important; }
            body:not(.sketch-enabled) #sketchPage { display:none !important; }
            .page {
                margin:0 !important; box-shadow:none !important; border:none !important;
                width:190mm; min-height:auto; height:auto; padding:8mm 10mm 14mm 10mm;
                page-break-after:always; page-break-inside:avoid; break-after:page; break-inside:avoid;
            }
            .footer { position:static; margin-top:6mm; left:auto; right:auto; bottom:auto; }
            .page:last-of-type { page-break-after:auto; break-after:auto; }
            input[type="text"], input[type="date"], input[type="number"], textarea, select, .photo-desc {
                border:none !important; background:transparent !important; padding:0 !important; -webkit-appearance:none; appearance:none;
            }
            .drawing-area { border:1px solid #000 !important; background:transparent !important; }
            .sketch-box { height:180mm !important; }
            .img-container { height:55mm !important; }
            .photo-box { border-color:#000 !important; }
        }
    </style>
</head>
<body>

<div id="controls" class="no-print">
    <button class="secondary" onclick="window.print()">DRUCKEN</button>
    <button class="secondary" onclick="sendEmail()">EMAIL SENDEN</button>
    <button class="secondary" onclick="clearSketch()">SKIZZE L√ñSCHEN</button>

    <input type="file" id="photoInput" multiple accept="image/*" style="display:none" onchange="handlePhotos(this)">
    <button class="secondary" onclick="document.getElementById('photoInput').click()">FOTOS HINZUF√úGEN</button>

    <button class="secondary" onclick="exportFullReport()">BERICHT SPEICHERN</button>
    <button class="secondary" onclick="document.getElementById('importFile').click()">BERICHT LADEN</button>
    <input type="file" id="importFile" accept=".lok,application/json" style="display:none" onchange="importFullReport(this)">
</div>

<div class="page" id="mainPage">
    <div class="header">
        <div class="header-left">
            <img src="Logo.PNG" alt="Brugger Logo" class="logo" onerror="this.style.display='none'">
            <h1>Leckortungsbericht</h1>
        </div>
        <div class="header-right">
            <strong>Brugger Entfeuchtung &amp; Kanaltechnik GmbH</strong><br />
            Liebenauer Hauptstra√üe 181, 8041 Graz<br />
            Tel: +43 316 471771 | office@brugger-entfeuchtung.at
        </div>
    </div>

    <div class="section">
        <h2>Kundendaten</h2>
        <div class="grid">
            <div><span class="label">Kunde / Name</span><input type="text" id="name"></div>
            <div><span class="label">Datum</span><input type="date" id="datum"></div>
        </div>
        <div style="margin-top:6px">
            <span class="label">Einsatzadresse</span>
            <input type="text" id="adresse" placeholder="Stra√üe / Hausnummer">
            <div class="grid" style="margin-top:6px; grid-template-columns: 80px 1fr 1.2fr;">
                <input type="text" id="plz" placeholder="PLZ">
                <input type="text" id="ort" placeholder="Ort">
                <input type="text" id="telefon" placeholder="Telefonnummer">
            </div>
        </div>
    </div>

    <div class="section">
        <h2>Schadensanalyse &amp; Befund</h2>
        <textarea id="befund" placeholder="Ergebnisse der Ortung..."></textarea>
    </div>

    <div class="section grid">
        <div>
            <h2>Ma√ünahmen</h2>
            <div class="checkbox-group">
                <label class="checkbox-item"><input type="checkbox"> <span>Trocknung</span></label>
                <label class="checkbox-item"><input type="checkbox"> <span>Sanierung</span></label>
                <label class="checkbox-item"><input type="checkbox"> <span>Verstopfungsbehebung</span></label>
                <label class="checkbox-item"><input type="checkbox" id="checkReparatur"> <span>Reparatur</span></label>
                <label class="checkbox-item"><input type="checkbox" id="checkSonstiges" onclick="toggleSonstiges()"> <span>Sonstiges</span></label>
            </div>
            <input type="text" id="inputSonstiges" placeholder="..." style="display:none; margin-top:6px;">
            <div id="flachdachTextOptions" class="no-print" style="margin-top:6px; display:none;">
                <span class="label">Textvorlage f√ºr Befund</span>
                <select id="flachdachTemplate">
                    <option value="">- w√§hlen -</option>
                </select>
            </div>
        </div>
        <div>
            <h2>Leistungen</h2>
            <div class="checkbox-group">
                <label class="checkbox-item"><input type="checkbox" id="checkLOPauschale"> <span>LO Pauschale</span></label>
                <label class="checkbox-item"><input type="checkbox" id="checkLeckortung"> <span>Leckortung</span></label>
                <label class="checkbox-item"><input type="checkbox" id="checkOptLeckortung"> <span>opt. Leckortung</span></label>
                <label class="checkbox-item"><input type="checkbox"> <span>Thermografie</span></label>
                <label class="checkbox-item"><input type="checkbox" id="checkFlachdach"> <span>Flachdach-Pr√ºf.</span></label>
                <label class="checkbox-item"><input type="checkbox"> <span>Pool LO</span></label>
            </div>
            <div id="zeitContainer" style="margin-top:8px; display:none;">
                <div class="grid">
                    <div><span class="label">Arbeitszeit (Std)</span><input type="number" step="0.5" placeholder="0.0"></div>
                    <div><span class="label">Fahrzeit (Std)</span><input type="number" step="0.5" placeholder="0.0"></div>
                </div>
            </div>
            <div class="grid" style="margin-top:6px;">
                <div><span class="label">Fahrzone</span><select><option value="">- w√§hlen -</option><option>1</option><option>2</option><option>3</option><option>4</option><option>5</option></select></div>
                <div><span class="label">Ortungsgas (l)</span><select><option>0</option><option>5</option><option>10</option><option>20</option><option>50</option></select></div>
            </div>
        </div>
    </div>

    <div class="section" id="reparaturSection">
        <h2>Reparatur &amp; Pr√ºfdetails</h2>
        <div id="reparaturWorks" style="margin-bottom: 6px; display:none;">
            <span class="label">Erforderliche Reparaturarbeiten</span>
            <textarea id="reparatur" placeholder="..."></textarea>
        </div>
        <div class="grid" style="margin-bottom: 8px;">
            <div><span class="label">Betroffene R√§ume</span><input type="text" placeholder="..."></div>
            <div><span class="label">Etage</span><input type="text" placeholder="..."></div>
        </div>
        <div class="checkbox-group" style="grid-template-columns: repeat(3, 1fr);">
            <label class="checkbox-item"><input type="checkbox"> <span>Ursache bereits behoben</span></label>
            <label class="checkbox-item"><input type="checkbox"> <span>Druckabfall</span></label>
            <label class="checkbox-item"><input type="checkbox"> <span>Feuchtigkeit</span></label>
            <label class="checkbox-item"><input type="checkbox"> <span>Tracergas</span></label>
            <label class="checkbox-item"><input type="checkbox"> <span>Endoskopie</span></label>
            <label class="checkbox-item"><input type="checkbox"> <span>Thermografie</span></label>
            <label class="checkbox-item"><input type="checkbox"> <span>Rohrkamera</span></label>
            <label class="checkbox-item"><input type="checkbox"> <span>Druckpr√ºfung</span></label>
            <label class="checkbox-item"><input type="checkbox"> <span>Absperrblase</span></label>
            <label class="checkbox-item"><input type="checkbox"> <span>Nebelverfahren</span></label>
            <label class="checkbox-item"><input type="checkbox"> <span>Luminatsp√ºlung</span></label>
            <label class="checkbox-item"><input type="checkbox"> <span>Feuchtigkeitsmessung</span></label>
            <label class="checkbox-item"><input type="checkbox"> <span>Akustik</span></label>
            <label class="checkbox-item"><input type="checkbox"> <span>Stemmarbeiten</span></label>
            <label class="checkbox-item"><input type="checkbox" id="checkSonstigesReparatur" onclick="toggleSonstigesReparatur()"> <span>Sonstiges</span></label>
        </div>
        <input type="text" id="inputSonstigesReparatur" placeholder="..." style="display:none; margin-top:6px;">
    </div>

    <div class="section no-print">
        <label class="checkbox-item">
            <input type="checkbox" id="toggleSketch">
            <span>Skizzenseite (Seite 2) beim Bericht verwenden</span>
        </label>
    </div>
    <div class="footer"><span>Brugger GmbH</span><span>Seite 1</span></div>
</div>

<div class="page" id="sketchPage">
    <div class="header">
        <div class="header-left">
            <h1>Skizze / Grundriss</h1>
        </div>
    </div>

    <div class="toolbar no-print">
        <div class="tool active" style="background:#000" onclick="setTool('#000', 2, this)"></div>
        <div class="tool" style="background:#0000FF" onclick="setTool('#0000FF', 2, this)"></div>
        <div class="tool" style="background:#FF0000" onclick="setTool('#FF0000', 2, this)"></div>
        <div class="tool" style="background:#00AA00" onclick="setTool('#00AA00', 2, this)"></div>
        <div class="tool eraser" onclick="setTool('#fafafa', 15, this)">üßΩ</div>
    </div>

    <canvas id="sketch-canvas" class="drawing-area sketch-box"></canvas>
    <p style="font-size:10px; color:#777; margin-top:5px; font-weight:bold;">üîµ Wasser | üî¥ Heizung | üü¢ Abfluss</p>
    <div class="footer"><span>Brugger GmbH</span><span>Seite 2</span></div>
</div>

<div id="photoPagesContainer"></div>

<script>
/* =========================
   Initialisierung / Helpers
   ========================= */
const dateInput = document.getElementById('datum');
if (dateInput) {
    try {
        if ('valueAsDate' in dateInput) {
            dateInput.valueAsDate = new Date();
        } else {
            dateInput.value = new Date().toISOString().split('T')[0];
        }
    } catch (e) {
        dateInput.value = new Date().toISOString().split('T')[0];
    }
}
let currentStyle = '#000';
let currentWidth = 2;

/* Zentrale Funktion f√ºr Dateinamen und Dokument-Titel */
function buildReportBaseName() {
    const adr = document.getElementById('adresse')?.value.trim() || '';
    const plz = document.getElementById('plz')?.value.trim() || '';
    const ort = document.getElementById('ort')?.value.trim() || '';
    const baseTitle = 'Leckortungsbericht';

    let locationPart = `${plz} ${ort}`.trim();
    
    let titleParts = [];
    if (locationPart) titleParts.push(locationPart);
    if (adr) titleParts.push(adr);

    if (titleParts.length > 0) {
        return `${baseTitle} - ${titleParts.join(', ')}`;
    } else {
        return baseTitle;
    }
}

function updateTitleWithAddress() {
    // Setzt den Titel im Browser (wird als Dateiname beim PDF-Druck verwendet)
    document.title = buildReportBaseName();
}

// Live-Aktualisierung des Titels bei Texteingabe
document.getElementById('adresse')?.addEventListener('input', updateTitleWithAddress);
document.getElementById('plz')?.addEventListener('input', updateTitleWithAddress);
document.getElementById('ort')?.addEventListener('input', updateTitleWithAddress);
updateTitleWithAddress(); // Initialer Aufruf

function autoResize() { this.style.height = 'auto'; this.style.height = (this.scrollHeight + 2) + 'px'; }
document.querySelectorAll('textarea').forEach(el => el.addEventListener('input', autoResize));

/* =========================
   Zust√§nde / Sichtbarkeiten
   ========================= */
const checkFlachdach = document.getElementById('checkFlachdach');
const reparaturSection = document.getElementById('reparaturSection');
const befundTextarea = document.getElementById('befund');
const flachdachTextOptions = document.getElementById('flachdachTextOptions');
const flachdachTemplateSelect = document.getElementById('flachdachTemplate');

const checkReparatur = document.getElementById('checkReparatur');
const reparaturWorks = document.getElementById('reparaturWorks');

function applyReparaturState() {
    if (!checkReparatur || !reparaturWorks) return;
    reparaturWorks.style.display = checkReparatur.checked ? '' : 'none';
}
checkReparatur?.addEventListener('change', applyReparaturState);
applyReparaturState();

const toggleSketch = document.getElementById('toggleSketch');
const sketchPage = document.getElementById('sketchPage');
if (toggleSketch) {
    document.body.classList.remove('sketch-enabled');
    toggleSketch.addEventListener('change', () => {
        if (toggleSketch.checked) {
            document.body.classList.add('sketch-enabled');
            if (sketchPage) sketchPage.style.display = '';
        } else {
            document.body.classList.remove('sketch-enabled');
        }
        renumberPhotoPages();
    });
}

function setTemplateOptions(mode) {
    if (!flachdachTemplateSelect) return;
    const prev = flachdachTemplateSelect.value;
    const base = `<option value="">- w√§hlen -</option>`;
    let opts = '';
    if (mode === 'flachdach') {
        opts = `
            <option value="funkenschlag">Funkenschlag</option>
            <option value="roofscan">RoofScan</option>
        `;
    } else if (mode === 'leckortung') {
        opts = `
            <option value="heizung">Heizung</option>
            <option value="blei">Blei Wohnung</option>
            <option value="silikonfuge">Silikonfuge</option>
            <option value="gasaustritt">Gasaustritt Whg</option>
        `;
    } else {
        flachdachTemplateSelect.innerHTML = base;
        flachdachTemplateSelect.value = '';
        return;
    }
    flachdachTemplateSelect.innerHTML = base + opts;
    const stillExists = Array.from(flachdachTemplateSelect.options).some(o => o.value === prev);
    flachdachTemplateSelect.value = stillExists ? prev : '';
}

function applyTemplateVisibility() {
    if (!flachdachTextOptions) return;
    const cf = document.getElementById('checkFlachdach');
    const cl = document.getElementById('checkLeckortung');
    const clo = document.getElementById('checkLOPauschale');
    const co = document.getElementById('checkOptLeckortung');

    const flachdachOn = !!(cf && cf.checked);
    const leckOn = !!((cl && cl.checked) || (clo && clo.checked) || (co && co.checked));

    if (flachdachOn) {
        flachdachTextOptions.style.display = 'block';
        setTemplateOptions('flachdach');
    } else if (leckOn) {
        flachdachTextOptions.style.display = 'block';
        setTemplateOptions('leckortung');
    } else {
        flachdachTextOptions.style.display = 'none';
        setTemplateOptions(null);
    }
}
checkFlachdach?.addEventListener('change', applyFlachdachState);
function applyFlachdachState() {
    if (!checkFlachdach) return;
    if (checkFlachdach.checked) {
        if (reparaturSection) reparaturSection.style.display = 'none';
        if (sketchPage) sketchPage.style.display = 'none';
        if (toggleSketch) {
            toggleSketch.checked = false;
            document.body.classList.remove('sketch-enabled');
        }
    } else {
        if (reparaturSection) reparaturSection.style.display = '';
        if (sketchPage) sketchPage.style.display = '';
    }
    applyTemplateVisibility();
    renumberPhotoPages();
}
applyFlachdachState();

/* Vorlagentexte (werden in den Befund eingesetzt) */
const FLACHDACH_TEXT_FUNKENSCHLAG =
`√úberpr√ºfung der Kunststoff Flachdachabdichtung des Hauptdaches mittels Funkenschlagverfahren.

Die Leckageortung mit dem Funkenschlagverfahren (Trockenortungsverfahren) ist f√ºr das Auffinden von L√∂chern und Rissen auf nicht leitf√§higen Beschichtungen oder Abdichtungen ohne Auflastung geeignet.
Das Hochspannung-Verfahren sp√ºrt feinste kapillare Undichtigkeiten auf. Beim Funkenschlagverfahren wird Hochspannung verwendet, die √ºber eine Kupferb√ºrste auf die zu pr√ºfende Abdichtung √ºbertragen wird.
Mit dem Funkenschlagverfahren k√∂nnen auch Punkt- und Nahtortungen durchgef√ºhrt werden.
Die H√∂he der elektrischen Spannung richtet sich nach der Schichtdicke des zu pr√ºfenden Materials.
Damit k√∂nnen Leckagen durch Funkenentladung, sowie durch optische und akustische Anzeige, sichtbar gemacht und punktgenau geortet werden.

Bei der √úberpr√ºfung der Flachdachfl√§che des Hauptdaches wurden 24 Verdachtsbereiche festgestellt.`;

const FLACHDACH_TEXT_ROOFSCAN =
`1. Ausgangssituation:
An der Decke im 1. Untergeschoss wurde ein Wassereintritt im Bereich eines Gullys festgestellt.
Dar√ºber befindet sich die Flachdachabdichtung der Terrasse.

Der Aufbau des Flachdaches stellt sich wie folgt dar:
- Stahlbetondecke
- Abdichtung
- Isolierung
- Kies
- Betonplatten

Zur Lokalisierung der Wasserdurchtritte wurden Untersuchungen mittels einer Potential-Differenzmessung durchgef√ºhrt.
Es wurde nur ein Teilbereich der Terrasse √ºberpr√ºft.

2. Durchf√ºhrung der Messung und vorbereitende Ma√ünahmen:
Zur Charakterisierung von m√∂glichen Leckagen im Abdichtungssystem wurden gerichtete elektrische Felder zwischen der Einspeisung an der Schadstelle und einem mobilen Sensor im Messbereich erzeugt. Wegsamkeitsbereiche durch das Abdichtungssystem √§u√üern sich durch erh√∂hte Energiedurchtritte des Tracersignals.

3. Untersuchungsergebnisse:
Es wurde zum Zeitpunkt der √úberpr√ºfung ein Verdachtsbereich V1 ermittelt.
Der Verdachtsbereich befindet sich ca. 3 m neben dem betroffenen Gully.
Da eine punktuelle Lokalisierung der Undichtheit aufgrund der Witterung nicht m√∂glich ist, wird empfohlen, die gesamte Flachdachfl√§che nach einem Niederschlag nochmals zu pr√ºfen.`;

const TEXT_HEIZUNG =
`Es wurde ein Wasserverlust auf der Heizungsanlage festgestellt.
Es wurden Druckproben auf den einzelnen Kreisen der Heizungsanlage durchgef√ºhrt.
Es wurde ein Druckverlust auf dem Heizkreis zum Gastraum festgestellt.

Die Heizungsleitungen zum Gastraum wurden entleert und mit Ortungsgas bef√ºllt.
Es wurde ein Gasaustritt in der Heizungsleitung im Bereich des Gastraums festgestellt.`;

const TEXT_BLEI_WOHNUNG =
`An den W√§nden zum Badezimmer wurden Vern√§ssungen festgestellt.
Es erfolgte die √úberpr√ºfung der Druck- und Ablaufleitungen im Schadensbereich.

Bei den Druckleitungen wurde zum Zeitpunkt der √úberpr√ºfung keine Undichtheit festgestellt.
Bei der √úberpr√ºfung der Ablaufleitungen wurden Undichtheiten in der Bleileitung des Waschtisches in der Wand und im Fu√übodenaufbau sowie Undichtheiten in der Bleileitung zum Gully festgestellt.`;

const TEXT_SILIKONFUGE =
`An einer Wand zum Badezimmer wurden Vern√§ssungen festgestellt.
Es erfolgte die √úberpr√ºfung der Druck- und Ablaufleitungen in der gesamten Wohnung.
Zum Zeitpunkt der √úberpr√ºfung wurde keine Undichtheit an den Druck- und Ablaufleitungen festgestellt.

Es wurden Undichtheiten in der Silikonabdichtung der Badewanne festgestellt.`;

const TEXT_GASAUSTritt_WHG =
`Es wurden an der Wand vom Kinderzimmer zum Badezimmer Vern√§ssungen festgestellt.
Es erfolgte die √úberpr√ºfung der Druck- und Ablaufleitungen in der Wohnung.
Die Druckleitungen wurden abgesperrt, entleert und mit Ortungsgas bef√ºllt.

Es wurde ein Gasaustritt in der Warmwasserleitung in der Wand zur Duscharmatur festgestellt.`;

if (flachdachTemplateSelect && befundTextarea) {
    flachdachTemplateSelect.addEventListener('change', () => {
        const v = flachdachTemplateSelect.value;
        if (v === 'funkenschlag') befundTextarea.value = FLACHDACH_TEXT_FUNKENSCHLAG;
        else if (v === 'roofscan') befundTextarea.value = FLACHDACH_TEXT_ROOFSCAN;
        else if (v === 'heizung') befundTextarea.value = TEXT_HEIZUNG;
        else if (v === 'blei') befundTextarea.value = TEXT_BLEI_WOHNUNG;
        else if (v === 'silikonfuge') befundTextarea.value = TEXT_SILIKONFUGE;
        else if (v === 'gasaustritt') befundTextarea.value = TEXT_GASAUSTritt_WHG;
        autoResize.call(befundTextarea);
    });
}

const checkLeckortung = document.getElementById('checkLeckortung');
const zeitContainer = document.getElementById('zeitContainer');
function applyLeckortungState() {
    if (!checkLeckortung || !zeitContainer) return;
    zeitContainer.style.display = checkLeckortung.checked ? '' : 'none';
    applyTemplateVisibility();
}
checkLeckortung?.addEventListener('change', applyLeckortungState);
applyLeckortungState();

document.getElementById('checkLOPauschale')?.addEventListener('change', applyTemplateVisibility);
document.getElementById('checkOptLeckortung')?.addEventListener('change', applyTemplateVisibility);
applyTemplateVisibility();

/* =========================
   Zeichnen / Skizze (Canvas)
   ========================= */
function initDrawing(canvasId) {
    const canvas = document.getElementById(canvasId);
    const ctx = canvas.getContext('2d');
    let drawing = false;

    function resize() {
        const rect = canvas.getBoundingClientRect();
        const temp = canvas.toDataURL();
        canvas.width = rect.width; canvas.height = rect.height;
        const img = new Image();
        img.onload = () => ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
        img.src = temp;
    }
    window.addEventListener('load', resize);
    window.addEventListener('resize', resize);

    function getPos(e) {
        const rect = canvas.getBoundingClientRect();
        const clientX = e.clientX || (e.touches && e.touches[0].clientX);
        const clientY = e.clientY || (e.touches && e.touches[0].clientY);
        return { x: clientX - rect.left, y: clientY - rect.top };
    }

    canvas.addEventListener('mousedown', () => { drawing = true; ctx.beginPath(); });
    canvas.addEventListener('mousemove', (e) => {
        if (!drawing) return;
        const pos = getPos(e);
        ctx.lineWidth = currentWidth; ctx.lineCap = 'round'; ctx.strokeStyle = currentStyle;
        ctx.lineTo(pos.x, pos.y); ctx.stroke();
    });
    window.addEventListener('mouseup', () => drawing = false);

    canvas.addEventListener('touchstart', (e) => { drawing = true; ctx.beginPath(); e.preventDefault(); }, {passive:false});
    canvas.addEventListener('touchmove', (e) => {
        if (!drawing) return;
        const pos = getPos(e);
        ctx.lineWidth = currentWidth; ctx.lineCap = 'round'; ctx.strokeStyle = currentStyle;
        ctx.lineTo(pos.x, pos.y); ctx.stroke(); e.preventDefault();
    }, {passive:false});
    canvas.addEventListener('touchend', () => drawing = false);

    return ctx;
}
const sketchCtx = initDrawing('sketch-canvas');

function setTool(color, width, el) {
    currentStyle = color; currentWidth = width;
    document.querySelectorAll('.tool').forEach(t => t.classList.remove('active'));
    el.classList.add('active');
}

function clearSketch() {
    const canvas = document.getElementById('sketch-canvas');
    sketchCtx.clearRect(0, 0, canvas.width, canvas.height);
}

/* =========================
   Fotos / Markierungen
   ========================= */
function handlePhotos(input) {
    const container = document.getElementById('photoPagesContainer');
    container.innerHTML = "";
    const files = Array.from(input.files);

    for (let i = 0; i < files.length; i += 4) {
        const page = document.createElement('div');
        page.className = 'page';
        const pageNum = calcPhotoPageNumber((i/4)|0);
        page.innerHTML = `
            <div class="header">
                <div class="header-left">
                    <img src="Logo.PNG" alt="Brugger Logo" class="logo" onerror="this.style.display='none'">
                    <h1>Fotodokumentation</h1>
                </div>
            </div>
            <div class="photo-grid" id="grid-${i}"></div>
            <div class="footer"><span>Brugger GmbH</span><span class="page-no">Seite ${pageNum}</span></div>
        `;
        container.appendChild(page);

        files.slice(i, i + 4).forEach((file) => {
            const reader = new FileReader();
            reader.onload = (e) => {
                // Aktiviert die Komprimierung vor dem Einf√ºgen
                scaleAndInsertPhoto(e.target.result, `grid-${i}`);
            };
            reader.readAsDataURL(file);
        });
    }
}

function calcPhotoPageNumber(photoPageIndex) {
    // Hauptseite = 1, Skizze (wenn aktiv) = 2, Fotoseiten ab 3 (oder 2, wenn Skizze aus)
    const hasSketch = !!(toggleSketch && toggleSketch.checked);
    return (hasSketch ? 3 : 2) + photoPageIndex;
}

function renumberPhotoPages() {
    const footers = document.querySelectorAll('#photoPagesContainer .page .footer .page-no');
    footers.forEach((el, idx) => {
        el.textContent = `Seite ${calcPhotoPageNumber(idx)}`;
    });
}

function addArrow(e, container) {
    const old = container.querySelector('.marker-arrow'); if (old) old.remove();
    const rect = container.getBoundingClientRect();
    const x = ((e.clientX - rect.left) / rect.width) * 100;
    const y = ((e.clientY - rect.top) / rect.height) * 100;

    const arrow = document.createElement('div');
    arrow.className = 'marker-arrow';
    arrow.style.left = x + '%';
    arrow.style.top  = y + '%';
    arrow.innerHTML = `
        <svg viewBox="0 0 100 100" fill="red">
            <path d="M10 10 L90 90 M90 50 L90 90 L50 90" stroke="white" stroke-width="5"/>
            <path d="M10 10 L90 90 M90 55 L90 90 L55 90" fill="red"/>
        </svg>`;
    container.appendChild(arrow);
}

function insertPhotoBox(imgSrc, gridId, descText = '', arrowPos = null) {
    const box = document.createElement('div');
    box.className = 'photo-box';
    box.innerHTML = `
        <div class="img-container" onclick="addArrow(event, this)">
            <img src="${imgSrc}">
        </div>
        <input type="text" class="photo-desc" placeholder="Beschreibung..." value="${descText ? (''+descText).replace(/"/g,'&quot;') : ''}">
    `;
    const grid = document.getElementById(gridId);
    grid.appendChild(box);

    if (arrowPos && typeof arrowPos.x === 'number' && typeof arrowPos.y === 'number') {
        const container = box.querySelector('.img-container');
        const arrow = document.createElement('div');
        arrow.className = 'marker-arrow';
        arrow.style.left = arrowPos.x + '%';
        arrow.style.top  = arrowPos.y + '%';
        arrow.innerHTML = `
            <svg viewBox="0 0 100 100" fill="red">
                <path d="M10 10 L90 90 M90 50 L90 90 L50 90" stroke="white" stroke-width="5"/>
                <path d="M10 10 L90 90 M90 55 L90 90 L55 90" fill="red"/>
            </svg>`;
        container.appendChild(arrow);
    }
}

// Aktives Downsizing beim Import (komprimiert Bilder drastisch)
function scaleAndInsertPhoto(dataUrl, gridId) {
    const img = new Image();
    img.onload = () => {
        const maxSide = 1000;
        let { width, height } = img;
        
        if (width > height && width > maxSide) {
            height = Math.round(height * (maxSide / width));
            width = maxSide;
        } else if (height >= width && height > maxSide) {
            width = Math.round(width * (maxSide / height));
            height = maxSide;
        }
        
        const c = document.createElement('canvas');
        c.width = width; 
        c.height = height;
        const cx = c.getContext('2d');
        cx.drawImage(img, 0, 0, width, height);
        
        // Komprimiert als JPEG mit 70% Qualit√§t (spart enorm viel Speicherplatz im PDF)
        const scaledDataUrl = cx.canvas.toDataURL('image/jpeg', 0.7);
        insertPhotoBox(scaledDataUrl, gridId);
    };
    img.src = dataUrl;
}

/* =========================
   Mailto (ohne Anhang)
   ========================= */
function sendEmail() {
    const subject = buildReportBaseName(); // Gleicher Name als E-Mail Betreff

    // Body aus aktuellen Feldern
    const nameEl = document.getElementById('name');
    const datumEl = document.getElementById('datum');
    const adresseEl = document.getElementById('adresse');
    const plzEl = document.getElementById('plz');
    const ortEl = document.getElementById('ort');
    const telEl = document.getElementById('telefon');
    const befundEl = document.getElementById('befund');
    const reparaturEl = document.getElementById('reparatur');

    const name = nameEl?.value || '';
    const datum = datumEl?.value || '';
    const adresse = adresseEl?.value || '';
    const plz = plzEl?.value || '';
    const ort = ortEl?.value || '';
    const tel = telEl?.value || '';
    const befund = befundEl?.value || '';
    const reparatur = reparaturEl?.value || '';

    let body = '';
    body += 'Leckortungsbericht\n';
    body += '-------------------\n\n';
    if (name) body += `Kunde / Name: ${name}\n`;
    if (datum) body += `Datum: ${datum}\n`;
    if (adresse || plz || ort) {
        body += 'Einsatzadresse:\n';
        body += `  ${adresse}\n`;
        body += `  ${plz} ${ort}\n`;
    }
    if (tel) body += `Telefon: ${tel}\n`;
    body += '\n';
    if (befund) { body += 'Schadensanalyse & Befund:\n' + befund + '\n\n'; }
    if (reparatur) { body += 'Erforderliche Reparaturarbeiten:\n' + reparatur + '\n\n'; }
    body += '\n---\nGesendet vom Leckortungsbericht-Formular.';

    const mailto = `mailto:kanal@brugger-entfeuchtung.at?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
    window.location.href = mailto;
}

/* =========================
   Vollst√§ndiges Speichern/Laden (.lok)
   ========================= */
function exportFullReport() {
    const data = {
        version: 1,
        meta: { savedAt: new Date().toISOString() },
        toggles: { sketchEnabled: !!(toggleSketch && toggleSketch.checked) },
        byId: {},
        inputsNoId: [],
        textareasNoId: [],
        selectsNoId: [],
        checkStatesOrdered: [],
        sketch: { png: null },
        photos: []
    };

    // Inputs/Textareas/Selects mit/ohne ID
    document.querySelectorAll('input').forEach(inp => {
        if (inp.type === 'checkbox') return;
        if (inp.id) data.byId[inp.id] = inp.value;
        else data.inputsNoId.push(inp.value);
    });
    document.querySelectorAll('textarea').forEach(ta => {
        if (ta.id) data.byId[ta.id] = ta.value;
        else data.textareasNoId.push(ta.value);
    });
    document.querySelectorAll('select').forEach(sel => {
        if (sel.id) data.byId[sel.id] = sel.value;
        else data.selectsNoId.push(sel.value);
    });

    // Checkboxen in Dokument-Reihenfolge
    const allChecks = Array.from(document.querySelectorAll('input[type="checkbox"]'));
    data.checkStatesOrdered = allChecks.map(c => !!c.checked);

    // Skizze als PNG
    try { data.sketch.png = document.getElementById('sketch-canvas').toDataURL('image/png'); }
    catch (_) { data.sketch.png = null; }

    // Fotoseiten erfassen
    const photoPages = Array.from(document.querySelectorAll('#photoPagesContainer .page'));
    photoPages.forEach((page, pageIdx) => {
        const grid = page.querySelector('.photo-grid');
        if (!grid) return;
        const boxes = Array.from(grid.querySelectorAll('.photo-box'));
        const images = boxes.map(box => {
            const img = box.querySelector('img');
            const desc = box.querySelector('.photo-desc')?.value || '';
            const arrow = box.querySelector('.marker-arrow');
            let arrowPos = null;
            if (arrow) {
                const x = parseFloat((arrow.style.left || '0').replace('%','')) || 0;
                const y = parseFloat((arrow.style.top  || '0').replace('%','')) || 0;
                arrowPos = { x, y };
            }
            return { dataUrl: img?.src || '', description: desc, arrow: arrowPos };
        });
        data.photos.push({ index: pageIdx, images });
    });

    // Gleicher Name, aber unzul√§ssige Dateizeichen entfernen (falls man z.B. einen Schr√§gstrich in die Adresse tippt)
    const safeFilename = buildReportBaseName().replace(/[<>:"/\\|?*]/g, '_');

    // Datei speichern (.lok)
    const blob = new Blob([JSON.stringify(data)], { type:'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = safeFilename + '.lok';
    a.click();
    URL.revokeObjectURL(url);
}

function importFullReport(inputEl) {
    const file = inputEl.files?.[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = (e) => {
        try {
            const data = JSON.parse(e.target.result);
            restoreFromData(data);
            inputEl.value = '';
        } catch (err) {
            console.error(err);
            alert('Datei konnte nicht geladen werden. Ist es eine g√ºltige .lok-Datei?');
        }
    };
    reader.readAsText(file);
}

function restoreFromData(data) {
    if (!data || typeof data !== 'object') return;

    // 1) ID-basierte Felder
    if (data.byId) {
        Object.keys(data.byId).forEach(id => {
            const el = document.getElementById(id);
            if (!el) return;
            if (el.tagName === 'SELECT' || el.tagName === 'TEXTAREA' || (el.tagName === 'INPUT' && el.type !== 'checkbox')) {
                el.value = data.byId[id];
                if (el.tagName === 'TEXTAREA') autoResize.call(el);
            }
        });
    }

    // 2) Reihenfolge-Felder ohne ID
    if (Array.isArray(data.inputsNoId)) {
        let idx = 0;
        document.querySelectorAll('input').forEach(inp => {
            if (inp.type === 'checkbox') return;
            if (inp.id) return;
            inp.value = data.inputsNoId[idx++] ?? '';
        });
    }
    if (Array.isArray(data.textareasNoId)) {
        let idx = 0;
        document.querySelectorAll('textarea').forEach(ta => {
            if (ta.id) return;
            ta.value = data.textareasNoId[idx++] ?? '';
            autoResize.call(ta);
        });
    }
    if (Array.isArray(data.selectsNoId)) {
        let idx = 0;
        document.querySelectorAll('select').forEach(sel => {
            if (sel.id) return;
            sel.value = data.selectsNoId[idx++] ?? '';
        });
    }

    // 3) Checkboxen (Dokument-Reihenfolge)
    if (Array.isArray(data.checkStatesOrdered)) {
        const allChecks = Array.from(document.querySelectorAll('input[type="checkbox"]'));
        allChecks.forEach((c, i) => { c.checked = !!data.checkStatesOrdered[i]; });
    }

    // Abh√§ngige Sichtbarkeiten
    applyReparaturState();
    applyLeckortungState();
    applyTemplateVisibility();

    // 4) Skizzenseite sichtbar/nicht, je nach gespeicherten Toggle
    if (data.toggles && typeof data.toggles.sketchEnabled === 'boolean' && toggleSketch) {
        toggleSketch.checked = data.toggles.sketchEnabled;
        toggleSketch.dispatchEvent(new Event('change'));
    }

    // 5) Skizze PNG in Canvas zeichnen
    if (data.sketch && data.sketch.png) {
        const canvas = document.getElementById('sketch-canvas');
        const img = new Image();
        img.onload = () => { sketchCtx.drawImage(img, 0, 0, canvas.width, canvas.height); };
        img.src = data.sketch.png;
    }

    // 6) Fotoseiten rekonstruieren
    const container = document.getElementById('photoPagesContainer');
    container.innerHTML = '';
    if (Array.isArray(data.photos) && data.photos.length) {
        data.photos.forEach((p, pageIdx) => {
            const page = document.createElement('div');
            page.className = 'page';
            page.innerHTML = `
                <div class="header">
                    <div class="header-left">
                        <img src="Logo.PNG" alt="Brugger Logo" class="logo" onerror="this.style.display='none'">
                        <h1>Fotodokumentation</h1>
                    </div>
                </div>
                <div class="photo-grid" id="grid-restore-${pageIdx}"></div>
                <div class="footer"><span>Brugger GmbH</span><span class="page-no">Seite ${calcPhotoPageNumber(pageIdx)}</span></div>
            `;
            container.appendChild(page);

            const gridId = `grid-restore-${pageIdx}`;
            if (Array.isArray(p.images)) {
                p.images.forEach(imgObj => {
                    insertPhotoBox(imgObj.dataUrl, gridId, imgObj.description, imgObj.arrow);
                });
            }
        });
    }
    
    // Titelleiste mit den geladenen Daten direkt aktualisieren
    updateTitleWithAddress();
}

/* =========================
   Kleine Helfer
   ========================= */
function toggleSonstiges() {
    const check = document.getElementById('checkSonstiges');
    document.getElementById('inputSonstiges').style.display = check.checked ? 'block' : 'none';
}
function toggleSonstigesReparatur() {
    const check = document.getElementById('checkSonstigesReparatur');
    document.getElementById('inputSonstigesReparatur').style.display = check.checked ? 'block' : 'none';
}
</script>
</body>
</html>
